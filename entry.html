<!-- entry html -->

<!DOCTYPE HTML>

<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>entry html</title>
  <style>
    form { margin: 10px 0 0 0; }
    form > input { width: 100%; box-sizing: border-box; margin: 0 0 5px 0; }
  </style>
</head>
<body>
  
  <h1>ENTRY</h1>
  
  <!-- login form -->
  <form id="logform" accept-charset="utf-8">
    <input type="text" id="logname" placeholder="name" />
    <input type="password" id="pwinput1" placeholder="password" />
    <input type="submit" id="logbtn" value="login!" />
  </form>
  
  <!-- register form -->
  <form id="regform" accept-charset="utf-8">
    <input type="text" id="regname" placeholder="name" />
    <input type="password" id="pwinput2" placeholder="password" />
    <input type="password" id="pwinput3" placeholder="confirm password" />
    <input type="submit" id="regbtn" value="register!" />
  </form>
  
  <!-- entry js -->
  <script type="text/javascript" charset="utf-8">
    'use strict;'
    
    // DOM objects
    const inp_nm1 = window.document.getElementById('logname');
    const inp_pw1 = window.document.getElementById('pwinput1');
    const btn_login = window.document.getElementById('logbtn');
    const inp_nm2 = window.document.getElementById('regname');
    const inp_pw2 = window.document.getElementById('pwinput2');
    const inp_pw3 = window.document.getElementById('pwinput3');
    const btn_register = window.document.getElementById('regbtn');
    
    // event handlers
    btn_login.onclick = e => {
      e.preventDefault();
      if ([inp_nm1, inp_pw1].every(i => /[^ ]+/.test(i.value))) {
        
        const myname = inp_nm1.value;
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/login', true);
        xhr.onload = e => {
          if (xhr.status === 401) {
            window.alert('Invalid login.');
            inp_nm1.focus();
          } else if (xhr.status === 200) {
            window.sessionStorage.setItem('myname', myname);
            // render chatroom
            window.document.open();
            window.document.write(xhr.responseText);
            window.document.close();
          }
        };
        xhr.send(JSON.stringify({
          name: inp_nm1.value, 
          password: inp_pw1.value  // ENC PASSWORD!
        }));
        
        inp_nm1.value = inp_pw1.value = '';
      } else {
        inp_nm1.focus();
      }
    };
    
    btn_register.onclick = e => {
      e.preventDefault();
      if ([inp_nm2, inp_pw2, inp_pw3].every(i => /[^ ]+/.test(i.value)) &&
          inp_pw2.value === inp_pw3.value) {
        
        const myname = inp_nm2.value;    
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/register', true);
        xhr.onload = e => {
          if (xhr.status === 423) {
            window.alert('Username unavailable.');
            inp_nm2.focus();
          } else if (xhr.status === 200) {
            window.sessionStorage.setItem('myname', myname);
            // render chatroom
            window.document.open();
            window.document.write(xhr.responseText);
            window.document.close();
          }
        };
        xhr.send(JSON.stringify({
          name: inp_nm2.value, 
          password: inp_pw2.value  // ENC PASSWORD!
        }));
        
        inp_nm2.value = inp_pw2.value = inp_pw3.value = '';
      } else {
        inp_nm2.focus();
      }
    };
    
    inp_nm1.value = window.sessionStorage.getItem('myname') || null;
    inp_nm1.value ? inp_pw1.focus() : inp_nm1.focus();
    
  </script>
  
</body>
</html>